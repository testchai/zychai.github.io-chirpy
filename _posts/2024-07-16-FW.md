---
title: åŸºäºFrank-Wolfeç®—æ³•æ±‚è§£äº¤é€šåˆ†é…UEæ¨¡å‹ #æ ‡é¢˜
date: 2024-04-10 10:00:00 +0800 #æ—¥æœŸï¼Œå¦‚æœæ—¥æœŸè¶…è¿‡å½“å‰æ—¶é—´ï¼Œæ— æ³•å‘å‡ºï¼Œå¯èƒ½ä¼šä½œä¸ºå®šæ—¶ï¼Ÿ
categories: [äº¤é€šè§„åˆ’, äº¤é€šåˆ†é…] # æ–‡ä»¶å¤¹åˆ†ç±»
tags: [UE, Frank Wolfe] # æ ‡ç­¾
math: true # å¯ç”¨æ•°å­¦
pin: false # ç½®é¡¶
authors: [æŸ´ä½œé›¨, é™ˆåŒ—ä¸€]
---

## ä¸€ã€ç”¨æˆ·å‡è¡¡æ¨¡å‹ç®€ç•¥ä»‹ç»

### 1.1 Wardrop ç¬¬ä¸€åŸç†

- é“è·¯çš„åˆ©ç”¨è€…ï¼Œéƒ½ç¡®åˆ‡çŸ¥é“ç½‘ç»œçš„äº¤é€šçŠ¶æ€ï¼Œå¹¶è¯•å›¾é€‰æ‹©æœ€çŸ­è·¯å¾„
- å½“ç½‘ç»œè¾¾åˆ°å¹³è¡¡çŠ¶æ€æ—¶ï¼Œæ¯ä¸ª OD å¯¹çš„å„æ¡è¢«ä½¿ç”¨çš„è·¯å¾„ï¼Œè¡Œé©¶æ—¶é—´ç›¸ç­‰ï¼Œä¸”è¡Œé©¶æ—¶é—´æœ€çŸ­
- æ²¡æœ‰è¢«ä½¿ç”¨çš„è·¯å¾„çš„è¡Œé©¶æ—¶é—´å¤§äºæˆ–ç­‰äºæœ€å°è¡Œé©¶æ—¶é—´

### 1.2 ç”¨æˆ·å‡è¡¡æ¨¡å‹

æ»¡è¶³ Wardrop ç¬¬ä¸€åŸç†çš„äº¤é€šåˆ†é…æ¨¡å‹ï¼Œç§°ä¸ºç”¨æˆ·å‡è¡¡æ¨¡å‹ã€‚

1956 å¹´ Beckmann æå‡ºäº†ä¸€ç§æ»¡è¶³ Wardrop ç¬¬ä¸€åŸç†çš„æ•°å­¦è§„åˆ’æ¨¡å‹ã€‚æ¨¡å‹æ ¸å¿ƒæ˜¯ï¼Œäº¤é€šç½‘ç»œä¸­çš„ç”¨æˆ·ï¼Œéƒ½è¯•å›¾é€‰æ‹©æœ€çŸ­è·¯å¾„ï¼Œè€Œæœ€ç»ˆä½¿å¾—è¢«é€‰æ‹©çš„è·¯å¾„çš„é˜»æŠ—æœ€å°ä¸”ç›¸ç­‰ã€‚è¯¥æ•°å­¦è§„åˆ’æ¨¡å‹ä¸ºï¼š

### 1.3 BPR å‡½æ•°

åœ¨ç”¨æˆ·å‡è¡¡æ¨¡å‹ä¸­ï¼ŒÂ $t_a$ ä¸ºè·¯é˜»å‡½æ•°ï¼Œæˆ‘ä»¬ä¸€èˆ¬é‡‡ç”¨ BPR å‡½æ•°ï¼Œå³ï¼š

$$
t_a\left( x_a \right) =FFT_a*\left[ 1+\alpha *\left( \frac{x_a}{C_a} \right) ^{\beta} \right]
$$

- $FFT_a$Â  è¡¨ç¤ºæœ€å¿«é€šè¿‡è·¯æ®µ a çš„æ—¶é—´
- $\alpha$Â  å¸¸å– 0.15ï¼Œ$\beta$Â  å¸¸å– 4.0
- $C_a$Â  è¡¨ç¤ºè·¯æ®µ $a$ çš„é€šè¡Œèƒ½åŠ›
- $x_a$Â  è¡¨ç¤ºè·¯æ®µ a çš„æµé‡

### 1.4 ç”¨æˆ·å‡è¡¡æ¨¡å‹çš„ç§¯åˆ†é¡¹

ä¸ºä¾¿äºåç»­æ±‚è§£ï¼Œæˆ‘ä»¬å°† BPR å‡½æ•°ä»£å…¥ $\int_0^{x_a}{t_a\left( w \right) dw}$Â  è¿›è¡Œç§¯åˆ†è®¡ç®—ï¼Œè¿‡ç¨‹å¦‚ä¸‹ :

$$
\begin{aligned}
\int_0^{x_a}t_a\left(w\right)dw& =\int_0^{x_a}FFT_a*\biggl[1+\alpha\biggl(\frac{w}{C_a}\biggr)^\beta\biggr]dw \\
&=C_a*FFT_a\int_0^{x_a}\biggl[1+\alpha\biggl(\frac w{C_a}\biggr)^\beta\biggr]d \frac w{C_a} \\
&=C_a*FFT_a\int_0^{\frac{x_a}{C_a}}(1+\alpha x^\beta)dx \\
&=C_a*FFT_a*\biggl(x+\frac\alpha{\beta+1}x^{\beta+1}\biggr)\biggr|_0^{\frac{x_a}{C_a}} \\
&=C_a*FFT_a*\biggl[\frac{x_a}{C_a}+\frac{\alpha}{\beta+1}\biggl(\frac{x_a}{C_a}\biggr)^{\beta+1}\biggr] \\
&=FFT_a{\left[x_a+\frac{\alpha C_a}{\beta+1}{\left(\frac{x_a}{C_a}\right)}^{\beta+1}\right]}
\end{aligned}
$$

å› æ­¤ï¼Œæˆ‘ä»¬çš„ç›®æ ‡å‡½æ•°ä¸ºï¼š

$$
\min Z\left( X \right) =\sum_a{FFT_a\left[ x_a+\frac{\alpha C_a}{\beta +1}\left( \frac{x_a}{C_a} \right) ^{\beta +1} \right]}
$$

## äºŒã€Frank Wolfe ç®—æ³•æ±‚è§£æ­¥éª¤

å‹æƒ…æé†’ï¼šåé¢è‹¥ä¸€æ—¶å¯¹ä»£ç ä¸»ä½“é€»è¾‘æœ‰ç–‘æƒ‘ï¼Œè¿”å›çœ‹çœ‹è¿™éƒ¨åˆ†ã€‚

æ­¥éª¤ 1ï¼šåˆå§‹åŒ–ã€‚åŸºäºé›¶æµå›¾çš„è·¯é˜»ï¼Œä¾æ¬¡æœç´¢æ¯ä¸€ä¸ª OD å¯¹ Â *r,s*Â  æ‰€å¯¹åº”çš„æœ€çŸ­è·¯å¾„ï¼Œå¹¶å°† Â *r,s*Â  é—´çš„ OD æµé‡ï¼Œå…¨éƒ¨åˆ†é…åˆ°å¯¹åº”çš„æœ€çŸ­è·¯å¾„ä¸Šï¼Œå¾—åˆ°åˆå§‹è·¯æ®µæµé‡ Â $X_1$Â ã€‚

æ­¥éª¤ 2ï¼šæ›´æ–°è·¯é˜»ã€‚æ ¹æ® BPR å‡½æ•°ï¼Œåˆ†åˆ«ä»£å…¥æ¯ä¸ªè·¯æ®µçš„åˆå§‹æµé‡ï¼Œæ±‚å¾—é˜»æŠ— Â $W_1$Â ã€‚

æ­¥éª¤ 3ï¼šä¸‹é™æ–¹å‘ã€‚åŸºäºé˜»æŠ— Â $W_1$ï¼ŒæŒ‰ç…§æ­¥éª¤ 1 ä¸­çš„æ–¹æ³•ï¼ˆæœ€çŸ­è·¯å…¨æœ‰å…¨æ— åˆ†é…ï¼‰ï¼Œå°†æµé‡é‡æ–°åˆ†é…åˆ°å¯¹åº”è·¯å¾„ä¸Šï¼Œå¾—åˆ°ä¸´æ—¶è·¯æ®µæµé‡ Â ${X_1}^*$Â ã€‚

æ­¥éª¤ 4ï¼šæœç´¢æœ€ä¼˜æ­¥é•¿ï¼Œå¹¶æ›´æ–°æµé‡ã€‚é‡‡ç”¨äºŒåˆ†æ³•ï¼Œæœç´¢æœ€ä¼˜æ­¥é•¿ Â $step^*$ Â ï¼Œå¹¶ä»¤

$$X_2=X_1+step^**({X_1}^*-X_1)$$

å…¶ä¸­ï¼Œæœ€ä¼˜æ­¥é•¿æ»¡è¶³ï¼š

$$\min Z\left[X_1+step^**\left(X_1\right.^*-X_1\right)],step\in(0,1]$$

æ­¥éª¤ 5ï¼šç»“æŸæ¡ä»¶ã€‚å¦‚æœ

$$ \frac{\sqrt{\sum*a{\left( x*{a}^{n+1}-x*{a}^{n} \right) ^2}}}{\sum_a{x*{a}^{n}}}\leqslant \boldsymbol{\epsilon } $$

ï¼Œåˆ™ç®—æ³•ç»“æŸï¼›å¦åˆ™ n=n+1ï¼Œè½¬è‡³æ­¥éª¤ 2ã€‚æ­¤å¤„çš„ Â ğœ€Â  è¡¨ç¤ºè¯¯å·®é˜ˆå€¼ï¼Œåœ¨ä»£ç éƒ¨åˆ†ç”¨ max_err è¡¨ç¤ºã€‚

## ä¸‰ã€ä»£ç 

ä»£ç åŸºäº Python çš„ NetWorkX åº“ç¼–å†™ï¼Œè¿™æ ·å°†å¤§å¤§å‡å°‘æˆ‘ä»¬ä»£ç ç¼–å†™çš„å·¥ä½œé‡ï¼Œå¹¶ä¸”æ›´æ˜“äºé˜…è¯»ã€‚æˆ‘ä»¬ä»¥ SiouxFalls äº¤é€šç½‘ç»œä¸ºä¾‹ï¼Œè¿›è¡Œäº¤é€šç½‘ç»œæ„å»ºä¸æµé‡åˆ†é…ã€‚

### 3.1 å¯¼å…¥å¿…è¦çš„åº“

```python
import pandas as pd
import numpy as np
import networkx as nx
import matplotlib.pyplot as plt
from scipy.optimize import minimize_scalar
```

- pandas ç”¨äºè¯»å–æ–‡ä»¶ã€å¯¼å‡ºç»“æœ
- numpy åœ¨è®¡ç®—è¯¯å·®æ—¶ä½¿ç”¨
- networkx è´¯ç©¿æ•´ä¸ªä»£ç 
- matplotlib ç”¨äºç»˜åˆ¶äº¤é€šç½‘ç»œå›¾
- scipy åœ¨æœç´¢æœ€ä¼˜æ­¥é•¿æ—¶ç”¨åˆ°

### 3.2 æ„å»ºäº¤é€šç½‘ç»œ

```python
def build_network(Link_path, Node_path):
    # è¯»å–ç‚¹æ•°æ®ã€è¾¹æ•°æ®
    links_df = pd.read_csv(Link_path)
    # éœ€è¦æ³¨æ„ä½¿ç”¨from_pandas_edgeï¼Œå…¶è¯»å–çš„è¾¹çš„é¡ºåºå’Œcsvä¸­è¾¹çš„é¡ºåºæœ‰å·®å¼‚
    G = nx.from_pandas_edgelist(links_df, source='O', target='D', edge_attr=['FFT', 'Capacity'], create_using=nx.DiGraph())
    nx.set_edge_attributes(G, 0, 'flow_temp')
    nx.set_edge_attributes(G, 0, 'flow_real')
    nx.set_edge_attributes(G, 0, 'descent')
    nx.set_edge_attributes(G, nx.get_edge_attributes(G, "FFT"), 'weight')

    # è·å–èŠ‚ç‚¹ä½ç½®ä¿¡æ¯
    nodes_df = pd.read_csv(Node_path)
    node_positions = {}
    for index, row in nodes_df.iterrows():
        node_positions[row['id']] = (row['pos_x'], row['pos_y'])
    # æ›´æ–°å›¾ä¸­èŠ‚ç‚¹çš„ä½ç½®å±æ€§
    nx.set_node_attributes(G, node_positions, 'pos')
    return G
```

- Link_pathï¼Œè¡¨ç¤ºè·¯ç½‘æ–‡ä»¶è·¯å¾„ã€‚ä¸‹è½½é“¾æ¥è§æ–‡æœ«ã€‚

- Node_pathï¼Œè¡¨ç¤ºèŠ‚ç‚¹æ–‡ä»¶è·¯å¾„ã€‚

- low_realï¼Œè¡¨ç¤ºæ¯æ¬¡è¿­ä»£æ›´æ–°åçš„è·¯æ®µæµé‡æˆ–åˆå§‹åŒ–æµé‡ï¼Œæ‰€æœ‰è·¯æ®µçš„ flow_real ç»„æˆ ${X_n}$
- flow_tempï¼Œæ‰€æœ‰è·¯æ®µçš„ flow_temp ç»„æˆ ${X_n}^âˆ—$
- descentï¼Œè¡¨ç¤º flow_temp ä¸ flow_real çš„å·®å€¼ï¼Œæ‰€æœ‰è·¯æ®µçš„ descent ç»„æˆ ${X_n}^âˆ—-{X_n}$
- weightï¼Œè¡¨ç¤ºè·¯é˜»ã€‚åˆå§‹çš„è·¯é˜»ï¼Œç”±äºè·¯æ®µæµé‡éƒ½æ˜¯ 0ï¼Œæ‰€ä»¥ç›´æ¥ç”¨ FFT è¡¨ç¤ºã€‚åç»­å°†ç”¨ BPR å‡½æ•°è®¡ç®—

### 3.3 ç»˜åˆ¶äº¤é€šè·¯ç½‘å›¾

```python
def draw_network(G):
    pos = nx.get_node_attributes(G, "pos")
    nx.draw(G, pos, with_labels=True, node_size=200, node_color='lightblue', font_size=10, font_weight='bold')
    plt.show()
```

æ„å»ºäº¤é€šç½‘ç»œåï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€çœ‹è¿™ä¸ª SiouxFalls ç½‘ç»œé•¿ä»€ä¹ˆæ ·å­å§

<!-- ![image.png](https://raw.githubusercontent.com/zychai/ImageBed/main/20240711031334.png) è¿™ä¸ªä¸èƒ½è°ƒå›¾ç‰‡å¤§å° -->

<div style="text-align: center;">
  <img src="https://raw.githubusercontent.com/zychai/ImageBed/main/20240711031334.png" width="600">
  <p><strong>å›¾ 1:</strong> äº¤é€šç½‘ç»œå›¾</p>
</div>

### 3.4 å®šä¹‰ BPR å‡½æ•°

```python
def BPR(FFT, flow, capacity, alpha=0.15, beta=4.0):
    return FFT * (1 + alpha * (flow / capacity) ** beta)
```

- FTTï¼Œè¡¨ç¤ºæœ€å¿«é€šè¿‡æ—¶é—´
- flowï¼Œè¡¨ç¤ºè·¯æ®µæµé‡
- capacityï¼Œè¡¨ç¤ºè·¯æ®µé€šè¡Œèƒ½åŠ›
- alpha å’Œ betaï¼Œæ˜¯ BPR å‡½æ•°çš„å‚æ•°ï¼Œåœ¨æ­¤å–é»˜è®¤å€¼

### 3.5 åˆå§‹åŒ–è·¯ç½‘æµé‡

```python
def all_none_initialize(G, od_df):
    # è¿™ä¸ªå‡½æ•°ä»…ä½¿ç”¨ä¸€æ¬¡ï¼Œç”¨äºåˆå§‹åŒ–
    # åœ¨é›¶æµå›¾ä¸Šï¼ŒæŒ‰æœ€çŸ­è·¯å…¨æœ‰å…¨æ— åˆ†é…ï¼Œç”¨äºæ›´æ–°flow_real
    for _, od_data in od_df.iterrows():
        source = od_data["o"]
        target = od_data["d"]
        demand = od_data["demand"]
        # è®¡ç®—æœ€çŸ­è·¯å¾„
        shortest_path = nx.shortest_path(G, source=source, target=target, weight="weight")
        # æ›´æ–°è·¯å¾„ä¸Šçš„æµé‡
        for i in range(len(shortest_path) - 1):
            u = shortest_path[i]
            v = shortest_path[i + 1]
            G[u][v]['flow_real'] += demand
    # åˆå§‹åŒ–æµé‡åï¼Œæ›´æ–°é˜»æŠ—
    for _, _, data in G.edges(data=True):
        data['weight'] = BPR(data['FFT'], data['flow_real'], data['Capacity'])
```

- è¿™ä¸ªå‡½æ•°ä»…ä½¿ç”¨ä¸€æ¬¡ï¼Œç”¨äºåˆå§‹åŒ–ã€‚åœ¨é›¶æµå›¾ä¸Šï¼ŒæŒ‰æœ€çŸ­è·¯å…¨æœ‰å…¨æ— åˆ†é…ï¼Œç”¨äºå¾—åˆ° Â $X_1$
- od_df è¡¨ç¤º pd.Dataframe æ•°æ®æ ¼å¼çš„ OD æµé‡ä¿¡æ¯ã€‚

### 3.6 è·å– flow_tempï¼Œå³ Â ${X_n}^*$

```python
def all_none_temp(G, od_df):
    # è¿™ä¸ªæ˜¯è™šæ‹Ÿåˆ†é…ï¼Œç”¨äºå¾—åˆ°flow_temp
    # æ¯æ¬¡æŒ‰æœ€çŸ­è·¯åˆ†é…å‰ï¼Œéœ€è¦å…ˆå°†flow_tempå½’é›¶
    nx.set_edge_attributes(G, 0, 'flow_temp')
    for _, od_data in od_df.iterrows():
        # æ¯æ¬¡æ›´æ–°éƒ½å¾—è¯»ODï¼Œåé¢å°è¯•ä¼˜åŒ–è¿™ä¸ª
        source = od_data["o"]
        target = od_data["d"]
        demand = od_data["demand"]
        # è®¡ç®—æœ€çŸ­è·¯å¾„
        shortest_path = nx.shortest_path(G, source=source, target=target, weight="weight")
        # æ›´æ–°è·¯å¾„ä¸Šçš„æµé‡
        for i in range(len(shortest_path) - 1):
            u = shortest_path[i]
            v = shortest_path[i + 1]
            # æ›´æ–°æµé‡
            G[u][v]['flow_temp'] += demand
```

### 3.7 è·å–ä¸‹é™æ–¹å‘ descentï¼Œå³ ${X_n}^*-X_n$

```python
def get_descent(G):
    for _, _, data in G.edges(data=True):
        data['descent'] = data['flow_temp'] - data['flow_real']
```

### 3.8 å®šä¹‰ç›®æ ‡å‡½æ•°

```python
def objective_function(temp_step, G):
    s, alpha, beta = 0, 0.15, 4.0
    for _, _, data in G.edges(data=True):
        x = data['flow_real'] + temp_step * data['descent']
        s += data["FFT"] * (x + alpha * data["Capacity"] / (beta + 1) * (x / data["Capacity"]) ** (beta + 1))
    return s
```

è¯¥éƒ¨åˆ†ä»£ç ï¼Œå¯¹åº”æœ¬æ–‡ 1.4 éƒ¨åˆ†çš„ç›®æ ‡å‡½æ•°ã€‚

### 3.9 ä¸€ç»´æœç´¢æœ€ä¼˜æ­¥é•¿ï¼Œå¹¶æ›´æ–°æµé‡

```python
def update_flow_real(G):
    # è¿™ä¸ªå‡½æ•°ç”¨äºè°ƒæ•´æµé‡ï¼Œå³flow_realï¼Œå¹¶æ›´æ–°weight
    best_step = get_best_step(G)  # è·å–æœ€ä¼˜æ­¥é•¿
    for _, _, data in G.edges(data=True):
        # è°ƒæ•´æµé‡ï¼Œæ›´æ–°è·¯é˜»
        data['flow_real'] += best_step * data["descent"]
        data['weight'] = BPR(data['FFT'], data['flow_real'], data['Capacity'])

def get_best_step(G, tolerance=1e-4):
    result = minimize_scalar(objective_function, args=(G,), bounds=(0, 1), method='bounded', tol=tolerance)
    return result.x
```

### 3.10 ä¸»å‡½æ•°

```python
def main():
    G = build_network("Link.csv", "Node.csv")  # æ„å»ºè·¯ç½‘
    draw_network(G)  # ç»˜åˆ¶äº¤é€šè·¯ç½‘å›¾
    od_df = pd.read_csv("ODPairs.csv")  # è·å–ODéœ€æ±‚æƒ…å†µ
    all_none_initialize(G, od_df)  # åˆå§‹åŒ–è·¯ç½‘æµé‡
    print("åˆå§‹åŒ–æµé‡", list(nx.get_edge_attributes(G, 'flow_real').values()))

    epoch = 0  # è®°å½•è¿­ä»£æ¬¡æ•°
    err, max_err = 1, 1e-4  # åˆ†åˆ«ä»£è¡¨åˆå§‹å€¼ã€æœ€å¤§å®¹è®¸è¯¯å·®
    f_list_old = np.array(list(nx.get_edge_attributes(G, 'flow_real').values()))
    while err > max_err:
        epoch += 1
        all_none_temp(G, od_df)  # å…¨æœ‰å…¨æ— åˆ†é…ï¼Œå¾—åˆ°flow_temp
        get_descent(G)  # è®¡ç®—æ¢¯åº¦ï¼Œå³flow_temp-flow_real
        update_flow_real(G)  # å…ˆæ˜¯ä¸€ç»´æœç´¢è·å–æœ€ä¼˜æ­¥é•¿ï¼Œå†è°ƒæ•´æµé‡ï¼Œæ›´æ–°è·¯é˜»

        # è®¡ç®—å¹¶æ›´æ–°è¯¯å·®err
        f_list_new = np.array(list(nx.get_edge_attributes(G, 'flow_real').values()))  # è¿™ä¸ªå˜é‡æ˜¯æ–°çš„è·¯ç½‘æµé‡åˆ—è¡¨
        d = np.sum((f_list_new - f_list_old) ** 2)
        err = np.sqrt(d) / np.sum(f_list_old)
        f_list_old = f_list_new

    print("å‡è¡¡æµé‡", list(nx.get_edge_attributes(G, 'flow_real').values()))
    print("è¿­ä»£æ¬¡æ•°", epoch)
    # å¯¼å‡ºç½‘ç»œå‡è¡¡æµé‡
    df = nx.to_pandas_edgelist(G)
    df = df[["source", "target", "flow_real"]].sort_values(by=["source", "target"])
    df.to_csv("ç½‘ç»œå‡è¡¡ç»“æœ.csv", index=False)


if __name__ == '__main__':
    main()
```

- epochï¼Œè¡¨ç¤ºè¿­ä»£æ¬¡æ•°
- errï¼Œè¡¨ç¤ºè¯¯å·®åˆå§‹å€¼
- max_errï¼Œè¡¨ç¤ºæœ€å¤§å®¹è®¸è¯¯å·®
- f_list_new, f_list_old åˆ†åˆ«è¡¨ç¤º Â ğ‘‹ğ‘›Â  å’Œ ğ‘‹ğ‘›âˆ’1ï¼Œç”¨äºè®¡ç®—è¯¯å·®

## å››ã€æ‰€ç”¨æ–‡ä»¶

ä¸‹è½½é“¾æ¥ï¼š[äº¤é€šåˆ†é…ï¼ˆUE æ¨¡å‹ï¼‰](https://link.zhihu.com/?target=https%3A//download.csdn.net/download/m0_61584121/88936726)
